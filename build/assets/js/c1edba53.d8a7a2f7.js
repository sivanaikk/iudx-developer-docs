"use strict";(self.webpackChunkiudx_website=self.webpackChunkiudx_website||[]).push([[2999],{3905:function(e,t,a){a.d(t,{Zo:function(){return c},kt:function(){return u}});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},m="mdxType",k={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),m=p(a),d=r,u=m["".concat(s,".").concat(d)]||m[d]||k[d]||o;return a?n.createElement(u,l(l({ref:t},c),{},{components:a})):n.createElement(u,l({ref:t},c))}));function u(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,l=new Array(o);l[0]=d;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i[m]="string"==typeof e?e:r,l[1]=i;for(var p=2;p<o;p++)l[p]=a[p];return n.createElement.apply(null,l)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},31259:function(e,t,a){a.r(t),a.d(t,{contentTitle:function(){return s},default:function(){return k},frontMatter:function(){return i},metadata:function(){return p},toc:function(){return c}});var n=a(87462),r=a(63366),o=(a(67294),a(3905)),l=["components"],i={sidebar_position:7},s=void 0,p={unversionedId:"Deployment/Docker Swarm-Based Deployment/IUDX Component Installation/Keycloak",id:"Deployment/Docker Swarm-Based Deployment/IUDX Component Installation/Keycloak",isDocsHomePage:!1,title:"Keycloak",description:"Architecture",source:"@site/docs/Deployment/Docker Swarm-Based Deployment/IUDX Component Installation/Keycloak.md",sourceDirName:"Deployment/Docker Swarm-Based Deployment/IUDX Component Installation",slug:"/Deployment/Docker Swarm-Based Deployment/IUDX Component Installation/Keycloak",permalink:"/docs/next/Deployment/Docker Swarm-Based Deployment/IUDX Component Installation/Keycloak",editUrl:"https://github.com/datakaveri/iudx-developer-docs/blob/main/docs/Deployment/Docker Swarm-Based Deployment/IUDX Component Installation/Keycloak.md",tags:[],version:"current",sidebarPosition:7,frontMatter:{sidebar_position:7},sidebar:"tutorialSidebar",previous:{title:"ELK stack",permalink:"/docs/next/Deployment/Docker Swarm-Based Deployment/IUDX Component Installation/ELK stack"},next:{title:"API Server",permalink:"/docs/next/Deployment/Docker Swarm-Based Deployment/IUDX Component Installation/API Server"}},c=[{value:"Prerequisites",id:"prerequisites",children:[],level:3},{value:"Installation",id:"installation",children:[],level:3},{value:"Notes",id:"notes",children:[],level:3},{value:"Keycloak Configuration",id:"keycloak-configuration",children:[],level:3}],m={toc:c};function k(e){var t=e.components,i=(0,r.Z)(e,l);return(0,o.kt)("wrapper",(0,n.Z)({},m,i,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("div",{class:"img_background"},(0,o.kt)("div",{style:{textAlign:"center"}},(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Architecture",src:a(11819).Z})))),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Keycloak is used as an Identity Manager and will be deployed using swarm stack YAML files.")),(0,o.kt)("h3",{id:"prerequisites"},"Prerequisites"),(0,o.kt)("p",null,"Generate the Keycloak database password during the PostgreSQL installation: ",(0,o.kt)("inlineCode",{parentName:"p"},"../postgresql/secrets/postgres-keycloak-password")),(0,o.kt)("h3",{id:"installation"},"Installation"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Navigate to the below directory :"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre"},"cd iudx-deployment/Docker-Swarm-deployment/single-node/keycloak/\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Assign the node label if not assigned during swarm installation:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre"},"docker node update --label-add keycloak-node=true <node_name>\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"To generate the passwords:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre"},"./create-secrets.sh\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Secrets directory after generation of secrets:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre"},"secrets/\n\u2514\u2500\u2500 passwords\n    \u251c\u2500\u2500 keycloak-admin-passwd\n    \u2514\u2500\u2500 keycloak-db-passwd\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Define Appropriate values of resources in ",(0,o.kt)("inlineCode",{parentName:"p"},"keycloak-stack.resources.yml")," as shown in the sample file ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("a",{parentName:"strong",href:"https://github.com/datakaveri/iudx-deployment/blob/master/Docker-Swarm-deployment/single-node/keycloak/example-keycloak-stack.resources.yaml"},"example-keycloak-stack.resources.yml")),"."),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"CPU requests and limits "),(0,o.kt)("li",{parentName:"ul"},"RAM requests and limits"),(0,o.kt)("li",{parentName:"ul"},"PID limit"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Deploy Keycloak stack as follows:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre"},"cp example-keycloak-stack.resources.yaml keycloak-stack.resources.yaml\n\ndocker stack deploy -c keycloak-stack.yaml -c keycloak-stack.resources.yaml keycloak\n")))),(0,o.kt)("h3",{id:"notes"},"Notes"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Keycloak UI can be accessed from ",(0,o.kt)("strong",{parentName:"li"},"https://< keycloak-domain-name >")),(0,o.kt)("li",{parentName:"ol"},"Keycloak is tls secured through centralised nginx."),(0,o.kt)("li",{parentName:"ol"},"To check if the keycloak stacks are deployed and running:",(0,o.kt)("inlineCode",{parentName:"li"},"docker stack ps keycloak")),(0,o.kt)("li",{parentName:"ol"},"For more information on installation instructions, refer ",(0,o.kt)("strong",{parentName:"li"},(0,o.kt)("a",{parentName:"strong",href:"https://github.com/datakaveri/iudx-deployment/tree/master/Docker-Swarm-deployment/single-node/keycloak"},"here")),".")),(0,o.kt)("h3",{id:"keycloak-configuration"},"Keycloak Configuration"),(0,o.kt)("p",null,"Refer to ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("a",{parentName:"strong",href:"https://github.com/datakaveri/iudx-aaa-server/issues/224#issuecomment-1228257142"},"this link"))," for additional details."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Create Realm")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Login to the admin console page with the realm set to the one you just created.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Add the login settings with the following configurations:"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"User registration: ON"),(0,o.kt)("li",{parentName:"ul"},"Email as username: ON"),(0,o.kt)("li",{parentName:"ul"},"Edit username: OFF"),(0,o.kt)("li",{parentName:"ul"},"Forgot password: ON (see ",(0,o.kt)("strong",{parentName:"li"},(0,o.kt)("a",{parentName:"strong",href:"https://github.com/datakaveri/iudx-aaa-server/issues/224#SMTP-Configuration"},"SMTP Configuration")),")"),(0,o.kt)("li",{parentName:"ul"},"Verify email: ON (see ",(0,o.kt)("strong",{parentName:"li"},(0,o.kt)("a",{parentName:"strong",href:"https://github.com/datakaveri/iudx-aaa-server/issues/224#SMTP-Configuration"},"SMTP Configuration")),")"),(0,o.kt)("li",{parentName:"ul"},"Login with email: ON")))),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"SMTP Configuration")),(0,o.kt)("p",null,"For Forgot password and Verify email functionalities to work, configure an SMTP connection. This allows Keycloak to send emails to the user, containing a reset password link or a verification link. Follow the ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("a",{parentName:"strong",href:"https://www.keycloak.org/docs/14.0/server_admin/#_email"},"Email Settings"))," to configure SMTP for the created realm."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Adding Roles")),(0,o.kt)("p",null,"Add roles to the realm as follows:\nRefer to ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("a",{parentName:"strong",href:"https://www.keycloak.org/docs/14.0/server_admin/#realm-roles"},"Realm Roles"))," for detailed instructions."),(0,o.kt)("p",null,"The roles to be added are:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"consumer"),(0,o.kt)("li",{parentName:"ul"},"delegate"),(0,o.kt)("li",{parentName:"ul"},"provider"),(0,o.kt)("li",{parentName:"ul"},"admin"),(0,o.kt)("li",{parentName:"ul"},"trustee")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Adding Clients")),(0,o.kt)("p",null,"Add clients to the realm. These clients are used by the AAA server to connect to Keycloak and perform certain tasks. Refer to ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("a",{parentName:"strong",href:"https://www.keycloak.org/docs/14.0/server_admin/#oidc-clients"},"OIDC Clients"))," to learn how to add new clients and explore different options present in the client settings."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Admin Client")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Create a new client with the Client ID as ",(0,o.kt)("inlineCode",{parentName:"p"},"keycloak-admin"),".")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Update the client settings in the Settings tab:"),(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},"Access Type set to confidential"),(0,o.kt)("li",{parentName:"ol"},"Standard Flow Enabled set to OFF"),(0,o.kt)("li",{parentName:"ol"},"Direct Access Grants Enabled set to OFF"),(0,o.kt)("li",{parentName:"ol"},"Service Accounts Enabled set to ON (this only appears if Access Type is confidential)"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Save the settings. Once saved, a new tab called Credentials will appear, containing the client secret. This, along with the client ID, is required when configuring the AAA server. See ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("a",{parentName:"strong",href:"https://www.keycloak.org/docs/14.0/server_admin/#_client-credentials"},"Client Credentials"))," for more information.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Another tab called Service Account Roles also appears. See ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("a",{parentName:"strong",href:"https://www.keycloak.org/docs/14.0/server_admin/#_service_accounts"},"Service Accounts"))," for more information."),(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},"In the Service Account Roles tab:"),(0,o.kt)("li",{parentName:"ol"},"In the Client Roles bar, go to realm-management and select it (see ",(0,o.kt)("strong",{parentName:"li"},(0,o.kt)("a",{parentName:"strong",href:"https://www.keycloak.org/docs/14.0/server_admin/#_per_realm_admin_permissions"},"Dedicated Realm Admin Consoles"))," for more information)"),(0,o.kt)("li",{parentName:"ol"},"In the Available Roles select box, add the following roles to the Assigned Roles box:",(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},"manage-users"),(0,o.kt)("li",{parentName:"ol"},"view-realm"),(0,o.kt)("li",{parentName:"ol"},"view-users")))),(0,o.kt)("p",{parentName:"li"},"The configuration for the keycloak-admin client is complete."))),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Normal Client")),(0,o.kt)("p",null,"Create a new client with the Client ID as ",(0,o.kt)("inlineCode",{parentName:"p"},"auth.iudx.org.in"),".\nUpdate the client settings in the Settings tab:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Access Type set to confidential"),(0,o.kt)("li",{parentName:"ul"},"Standard Flow Enabled set to OFF"),(0,o.kt)("li",{parentName:"ul"},"Direct Access Grants Enabled set to OFF"),(0,o.kt)("li",{parentName:"ul"},"Service Accounts Enabled set to ON (this only appears if Access Type is confidential)")),(0,o.kt)("p",null,"Save the settings. Once saved, a new tab called Credentials will appear, containing the client secret. This, along with the client ID, is required when configuring the AAA server. See ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("a",{parentName:"strong",href:"https://www.keycloak.org/docs/14.0/server_admin/#_client-credentials"},"Client Credentials"))," for more information."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Post Configuration")),(0,o.kt)("p",null,"After Keycloak is configured, you need to add the Keycloak host, port, client IDs, and client secrets to the config of the AAA server. Please refer to this ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/datakaveri/iudx-aaa-server/blob/3.5.0/configs/config-example.json"},"example config")," for more information. In the example config:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"keycloakAdminClient...")," corresponds to the ",(0,o.kt)("strong",{parentName:"li"},(0,o.kt)("a",{parentName:"strong",href:"https://github.com/datakaveri/iudx-aaa-server/issues/224#Admin-client"},"Admin client"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"keycloakAaaClient...")," corresponds to the ",(0,o.kt)("strong",{parentName:"li"},(0,o.kt)("a",{parentName:"strong",href:"https://github.com/datakaveri/iudx-aaa-server/issues/224#Admin-client"},"Normal client")))))}k.isMDXComponent=!0},11819:function(e,t,a){t.Z=a.p+"assets/images/keycloak-arch-696c091f5025042360654ecca4968abf.png"}}]);